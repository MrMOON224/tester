<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Identity Card - San School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loading" class="text-center text-gray-500 font-medium">Verifying Access...</div>
    <div id="debug-msg" class="text-xs text-gray-400 fixed top-0 left-0 p-2 hidden"></div>

    <div id="card-container"
        class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-sm w-full hidden transform transition-all duration-500 hover:scale-105">
        <!-- Header / Banner -->
        <div class="h-32 bg-gradient-to-r from-indigo-500 to-purple-600 relative">
            <div class="absolute -bottom-16 left-1/2 transform -translate-x-1/2">
                <div class="w-32 h-32 rounded-full border-4 border-white overflow-hidden bg-gray-200">
                    <img id="stu-photo" src="https://placehold.co/150x150?text=Student" alt="Student Photo"
                        class="w-full h-full object-cover">
                </div>
            </div>
        </div>

        <div class="pt-20 pb-8 px-6 text-center">
            <h1 class="text-2xl font-bold text-gray-900" id="stu-name">Student Name</h1>
            <p class="text-indigo-600 font-medium mt-1" id="stu-grade">Grade</p>

            <div class="mt-8 space-y-4 text-left">
                <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                    <span class="text-2xl mr-3">üè´</span>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-semibold">School</p>
                        <p class="text-gray-800 font-medium">San School</p>
                    </div>
                </div>

                <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                    <span class="text-2xl mr-3">üë®‚Äçüë©‚Äçüëß</span>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-semibold">Parent / Guardian</p>
                        <p class="text-gray-800 font-medium" id="parent-name">Parent Name</p>
                    </div>
                </div>

                <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                    <span class="text-2xl mr-3">üìû</span>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-semibold">Emergency Contact</p>
                        <p class="text-gray-800 font-medium" id="parent-contact">Phone</p>
                    </div>
                </div>

                <!-- Dynamic Teacher Info -->
                <div id="teacher-info"></div>

                <!-- Dynamic Performance Info -->
                <div id="perf-container"></div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100">
                <p class="text-xs text-gray-400">Verified Student Identity</p>
                <div
                    class="mt-2 inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold uppercase tracking-wide">
                    Active Student
                </div>
            </div>
        </div>
    </div>

    <div id="error-msg" class="hidden text-center bg-white p-8 rounded-lg shadow-lg">
        <div class="text-red-500 text-5xl mb-4">üö´</div>
        <h2 class="text-xl font-bold text-gray-900">Access Denied</h2>
        <p class="text-gray-600 mt-2">You do not have permission to view this student card.</p>
        <div class="mt-4 space-x-2">
            <a href="#"
                onclick="window.location.href='../parent/login.html?redirect='+encodeURIComponent(window.location.href); return false;"
                class="inline-block text-indigo-600 hover:text-indigo-800 border px-3 py-1 rounded">Parent Login</a>
            <a href="../admin/index.html" class="inline-block text-gray-600 hover:text-gray-800 text-sm">Admin
                Access</a>
        </div>
    </div>

    <script type="module">
        import { supabase } from '../assets/js/supabase-client.js';

        async function init() {
            // 1. Get Student ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('id');

            if (!studentId) {
                showError('Invalid Student ID');
                return;
            }

            // 2. Check Authentication (Hybrid)
            let currentUser = null;
            let isAdmin = false;

            // A) Check LocalStorage (Parent Custom Auth)
            const localSession = localStorage.getItem('school_user_custom');
            if (localSession) {
                try {
                    const session = JSON.parse(localSession);
                    if (session && session.user) {
                        currentUser = session.user;
                        currentUser.isCustom = true;
                    }
                } catch (e) { console.error('Session parse error', e); }
            }

            // B) Check Supabase Auth (Admin) checks take precedence if logged in
            if (!currentUser) {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    // Start checking role
                    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                    if (profile && profile.role === 'admin') {
                        currentUser = user;
                        isAdmin = true;
                    }
                }
            }

            if (!currentUser) {
                // Determine current URL to redirect back to
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `../parent/login.html?redirect=${returnUrl}`;
                return;
            }

            // 3. Fetch Student Data 
            // Query for Custom Parent requests now
            const { data: student, error } = await supabase
                .from('students')
                .select('*, parent_requests(id, full_name, phone_number)')
                .eq('id', studentId)
                .single();

            if (error || !student) {
                showError('Student not found or access denied.');
                return;
            }

            // 4. Verification Logic
            // If Admin: Allow
            // If Parent: Check ID match
            let isAllowed = false;

            if (isAdmin) {
                isAllowed = true;
            } else if (currentUser.isCustom) {
                // Check if the student belongs to this parent
                // Note: student.parent_id is the foreign key to parent_requests.id
                if (student.parent_id === currentUser.id) {
                    isAllowed = true;
                }
            }

            if (!isAllowed) {
                showError('You are logged in, but this student does not belong to you.');
                return;
            }

            // 5. Fetch Linked Teacher & Performance
            const { data: teacher } = await supabase.from('teachers').select('*').eq('grade', student.grade).single();
            const { data: performance } = await supabase.from('performance').select('*').eq('student_id', studentId).order('created_at', { ascending: false });

            // 6. Render
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('card-container').classList.remove('hidden');

            document.getElementById('stu-name').textContent = student.full_name;
            document.getElementById('stu-grade').textContent = student.grade;
            if (student.photo_url) document.getElementById('stu-photo').src = student.photo_url;

            document.getElementById('parent-name').textContent = student.parent_requests?.full_name || 'N/A';
            document.getElementById('parent-contact').textContent = student.parent_requests?.phone_number || 'N/A';

            // Render Teacher
            const teaContainer = document.getElementById('teacher-info');
            if (teacher) {
                teaContainer.innerHTML = `
                    <div class="flex items-center bg-indigo-50 p-3 rounded-lg mt-4 border border-indigo-100">
                        <img src="${teacher.photo_url || 'https://placehold.co/100'}" class="w-12 h-12 rounded-full object-cover mr-3 border-2 border-white">
                        <div>
                            <p class="text-xs text-indigo-500 uppercase font-bold">Class Teacher</p>
                            <p class="text-gray-900 font-semibold text-sm">${teacher.name}</p>
                        </div>
                    </div>
                `;
            }

            // Render Performance
            const perfContainer = document.getElementById('perf-container');
            if (performance && performance.length > 0) {
                const latest = performance[0]; // Show latest
                perfContainer.innerHTML = `
                   <div class="mt-6 pt-6 border-t border-gray-100">
                        <p class="text-xs text-gray-400 uppercase tracking-wide mb-3">Academic Performance (${latest.term})</p>
                        <div class="grid grid-cols-2 gap-2">
                             ${performance.slice(0, 4).map(p => `
                                <div class="bg-gray-50 p-2 rounded text-center">
                                    <p class="text-xs text-gray-500">${p.subject}</p>
                                    <p class="font-bold text-gray-800">${p.score}</p>
                                </div>
                             `).join('')}
                        </div>
                        ${latest.feedback ? `<p class="mt-3 text-sm text-gray-600 italic">"${latest.feedback}"</p>` : ''}
                   </div>
                `;
            }

        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-msg').classList.remove('hidden');
            console.error(msg);
        }

        init();
    </script>
</body>

</html>