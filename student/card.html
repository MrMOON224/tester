<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Identity Card - School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        school: { navy: '#0F172A', gold: '#D4AF37', cream: '#F9FAFB', blue: '#1E40AF' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'] }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F9FAFB;
        }

        .pattern-bg {
            background-image: url("https://www.transparenttextures.com/patterns/cubes.png");
            background-color: #0F172A;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loading" class="text-center text-gray-500 font-medium">Verifying Access...</div>
    <div id="debug-msg" class="text-xs text-gray-400 fixed top-0 left-0 p-2 hidden"></div>

    <div id="card-container" class="hidden max-w-md w-full mx-auto relative group">
        <!-- Print / Action Bar (Hidden in Print) -->
        <div
            class="absolute -top-12 right-0 flex max-w-md w-full justify-end space-x-2 print:hidden opacity-0 group-hover:opacity-100 transition duration-300">
            <button onclick="window.print()"
                class="text-xs font-bold text-slate-400 hover:text-school-navy uppercase tracking-widest"><i
                    class="fas fa-print mr-1"></i> Print</button>
        </div>

        <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-100">
            <!-- Minimal Header -->
            <div class="pattern-bg h-24 relative flex items-center justify-center">
                <div class="text-center">
                    <div
                        class="w-8 h-8 bg-school-gold text-school-navy flex items-center justify-center rounded mx-auto font-serif font-bold text-lg mb-1">
                        S</div>
                    <h1 class="text-white font-serif font-bold tracking-wide text-sm">SCHOOL</h1>
                </div>
            </div>

            <!-- Profile Section -->
            <div class="px-8 pb-8 -mt-12 text-center relative z-10">
                <div class="inline-block relative">
                    <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg overflow-hidden bg-white">
                        <img id="stu-photo" src="https://placehold.co/150x150?text=Student" alt="Student Photo"
                            class="w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-1 right-1 bg-emerald-500 border-2 border-white w-5 h-5 rounded-full"
                        title="Active"></div>
                </div>

                <div class="mt-4">
                    <h2 class="text-2xl font-bold text-school-navy font-serif" id="stu-name">Student Name</h2>
                    <p class="text-school-gold font-medium text-sm tracking-widest uppercase mt-1" id="stu-grade">Grade
                    </p>
                </div>

                <!-- Verified Badge -->
                <div class="mt-6 flex justify-center">
                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-slate-50 border border-slate-100">
                        <i class="fas fa-check-circle text-emerald-500 mr-2 text-xs"></i>
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Verified ID</span>
                    </div>
                </div>

                <!-- Info Grid -->
                <div class="mt-8 grid gap-4 text-left">
                    <!-- Parent -->
                    <div
                        class="flex items-center p-3 rounded-lg hover:bg-slate-50 transition border border-transparent hover:border-slate-100">
                        <div
                            class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 mr-4">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Guardian</p>
                            <p class="text-slate-700 font-medium text-sm" id="parent-name">Parent Name</p>
                        </div>
                    </div>

                    <!-- Contact -->
                    <div
                        class="flex items-center p-3 rounded-lg hover:bg-slate-50 transition border border-transparent hover:border-slate-100">
                        <div
                            class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 mr-4">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Emergency</p>
                            <p class="text-slate-700 font-medium text-sm font-mono" id="parent-contact">Phone</p>
                        </div>
                    </div>

                    <!-- Teacher (Dynamic) -->
                    <div id="teacher-info"></div>
                </div>

                <!-- Performance (Dynamic) -->
                <div id="perf-container" class="mt-6"></div>

            </div>

            <!-- Minimal Footer -->
            <div class="bg-slate-50 px-8 py-4 border-t border-slate-100 flex justify-between items-center">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">Academic Year 2026</p>
                <img src="https://placehold.co/40x40?text=QR" class="w-8 h-8 opacity-20 hidden md:block">
                <!-- Decorative -->
            </div>
        </div>
    </div>

    <div id="error-msg" class="hidden max-w-md w-full mx-auto text-center bg-white p-12 rounded-xl shadow-2xl">
        <div
            class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
            <i class="fas fa-lock"></i>
        </div>
        <h2 class="text-2xl font-bold text-school-navy font-serif mb-2">Access Restricted</h2>
        <p class="text-slate-500 mb-8">This student card is private. Please verify your identity to view.</p>

        <div class="space-y-3">
            <a href="#"
                onclick="window.location.href='../parent/login.html?redirect='+encodeURIComponent(window.location.href); return false;"
                class="block w-full py-3 bg-school-navy text-white rounded-lg font-medium hover:bg-slate-800 transition shadow-lg shadow-slate-900/20">
                Parent Login
            </a>
            <a href="../admin/index.html"
                class="block w-full py-3 text-slate-500 hover:text-slate-700 text-sm font-medium">Admin Access</a>
        </div>
    </div>

    <div id="debug-info"
        class="fixed bottom-0 left-0 bg-black text-white p-4 text-xs font-mono hidden w-full opacity-90 z-50"></div>

    <script type="module">
        import { supabase } from '../assets/js/supabase-client.js';

        function log(msg) {
            console.log(msg);
            const d = document.getElementById('debug-info');
            d.innerHTML += `<div>${msg}</div>`;
        }

        async function init() {
            try {
                // 1. Get Student ID
                const urlParams = new URLSearchParams(window.location.search);
                const studentId = urlParams.get('id');

                if (!studentId) {
                    showError('No Student ID provided in URL');
                    return;
                }

                log(`Checking ID: ${studentId}`);

                // 2. Resolve User
                let currentUser = null;
                let isAdmin = false;

                // Check LocalStorage
                const localSession = localStorage.getItem('school_user_custom');
                if (localSession) {
                    try {
                        const s = JSON.parse(localSession);
                        if (s && s.user) {
                            currentUser = s.user;
                            currentUser.isCustom = true;
                            log(`Local User Found: ${currentUser.phone}`);
                        }
                    } catch (e) { log('Session corrupted'); }
                }

                // Check Supabase (Admin overrides)
                // Only check if we suspect admin or no local user
                const { data: { user: sbUser } } = await supabase.auth.getUser();
                if (sbUser) {
                    const { data: profile } = await supabase.from('profiles').select('role').eq('id', sbUser.id).single();
                    if (profile && profile.role === 'admin') {
                        currentUser = sbUser;
                        isAdmin = true;
                        log('Admin Logged In');
                    }
                }

                if (!currentUser) {
                    log('No user. Redirecting...');
                    // Redirect Logic
                    const returnUrl = encodeURIComponent(window.location.href);
                    window.location.replace(`../parent/login.html?redirect=${returnUrl}`);
                    return;
                }

                // 3. Fetch Data
                const { data: student, error } = await supabase
                    .from('students')
                    .select('*, parent_requests(id, full_name, phone_number)')
                    .eq('id', studentId)
                    .single();

                if (error || !student) {
                    showError('Student not found in database.');
                    log(error ? error.message : 'NULL Data');
                    return;
                }

                log(`Student Parent ID: ${student.parent_id}`);
                log(`Current User ID: ${currentUser.id}`);

                // 4. Verify Access
                let isAllowed = false;
                if (isAdmin) isAllowed = true;
                else if (currentUser.isCustom && student.parent_id === currentUser.id) isAllowed = true;

                if (!isAllowed) {
                    showError('Access Denied: ID Mismatch');
                    // Show debug automatically on error
                    document.getElementById('debug-info').classList.remove('hidden');
                    log(` EXPECTED: ${student.parent_id}`);
                    log(` ACTUAL:   ${currentUser.id}`);
                    return;
                }

                // 5. Success - Fetch Details
                // Fetch Teacher & Performance
                const { data: teacher } = await supabase.from('teachers').select('*').eq('grade', student.grade).single();
                const { data: perf } = await supabase.from('performance').select('*').eq('student_id', studentId).order('created_at', { ascending: false });

                render(student, teacher, perf);

            } catch (err) {
                console.error(err);
                showError('System Error: ' + err.message);
            }
        }

        function render(student, teacher, performance) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('card-container').classList.remove('hidden');

            document.getElementById('stu-name').textContent = student.full_name;
            document.getElementById('stu-grade').textContent = student.grade;
            if (student.photo_url) document.getElementById('stu-photo').src = student.photo_url;

            document.getElementById('parent-name').textContent = student.parent_requests?.full_name || 'N/A';
            document.getElementById('parent-contact').textContent = student.parent_requests?.phone_number || 'N/A';

            if (teacher) {
                document.getElementById('teacher-info').innerHTML = `
                   <div class="flex items-center p-3 rounded-lg hover:bg-slate-50 transition border border-transparent hover:border-slate-100">
                        <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 mr-4 overflow-hidden">
                             ${teacher.photo_url ? `<img src="${teacher.photo_url}" class="w-full h-full object-cover">` : `<i class="fas fa-chalkboard-teacher"></i>`}
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Class Teacher</p>
                            <p class="text-slate-700 font-medium text-sm">${teacher.name}</p>
                        </div>
                   </div>`;
            }

            if (performance && performance.length > 0) {
                const latest = performance[0];
                document.getElementById('perf-container').innerHTML = `
                   <div class="mt-4 pt-4 border-t border-dashed border-slate-200">
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-3">Latest Performance (${latest.term})</p>
                        <div class="grid grid-cols-2 gap-3">
                             ${performance.slice(0, 4).map(p => `
                                <div class="bg-slate-50 p-2 rounded text-center border border-slate-100">
                                    <p class="text-[10px] text-slate-500 uppercase">${p.subject}</p>
                                    <p class="font-bold text-school-navy">${p.score}</p>
                                </div>`).join('')}
                        </div>
                   </div>`;
            }
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            const errDiv = document.getElementById('error-msg');
            errDiv.classList.remove('hidden');
            errDiv.querySelector('h2').textContent = msg; // Show specific reason logic
        }

        init();
    </script>
</body>

</html>