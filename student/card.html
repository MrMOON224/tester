<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Identity Card - San School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loading" class="text-center text-gray-500 font-medium">Verifying Access...</div>
    <div id="debug-msg" class="text-xs text-gray-400 fixed top-0 left-0 p-2 hidden"></div>

    <div id="card-container"
        class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-sm w-full hidden transform transition-all duration-500 hover:scale-105">
        <!-- Header / Banner -->
        <div class="h-32 bg-gradient-to-r from-indigo-500 to-purple-600 relative">
            <div class="absolute -bottom-16 left-1/2 transform -translate-x-1/2">
                <div class="w-32 h-32 rounded-full border-4 border-white overflow-hidden bg-gray-200">
                    <img id="stu-photo" src="https://placehold.co/150x150?text=Student" alt="Student Photo"
                        class="w-full h-full object-cover">
                </div>
            </div>
        </div>

        <div class="pt-20 pb-8 px-6 text-center">
            <h1 class="text-2xl font-bold text-gray-900" id="stu-name">Student Name</h1>
            <p class="text-indigo-600 font-medium mt-1" id="stu-grade">Grade</p>

            <div class="mt-8 space-y-4 text-left">
                <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                    <span class="text-2xl mr-3">üè´</span>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-semibold">School</p>
                        <p class="text-gray-800 font-medium">San School</p>
                    </div>
                </div>

                <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                    <span class="text-2xl mr-3">üë®‚Äçüë©‚Äçüëß</span>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-semibold">Parent / Guardian</p>
                        <p class="text-gray-800 font-medium" id="parent-name">Parent Name</p>
                    </div>
                </div>

                <div class="flex items-center bg-gray-50 p-3 rounded-lg">
                    <span class="text-2xl mr-3">üìû</span>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-semibold">Emergency Contact</p>
                        <p class="text-gray-800 font-medium" id="parent-contact">Phone</p>
                    </div>
                </div>

                <!-- Dynamic Teacher Info -->
                <div id="teacher-info"></div>

                <!-- Dynamic Performance Info -->
                <div id="perf-container"></div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100">
                <p class="text-xs text-gray-400">Verified Student Identity</p>
                <div
                    class="mt-2 inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold uppercase tracking-wide">
                    Active Student
                </div>
            </div>
        </div>
    </div>

    <div id="error-msg" class="hidden text-center bg-white p-8 rounded-lg shadow-lg">
        <div class="text-red-500 text-5xl mb-4">üö´</div>
        <h2 class="text-xl font-bold text-gray-900">Access Denied</h2>
        <p class="text-gray-600 mt-2">You do not have permission to view this student card.</p>
        <div class="mt-4 space-x-2">
            <a href="#"
                onclick="window.location.href='../parent/login.html?redirect='+encodeURIComponent(window.location.href); return false;"
                class="inline-block text-indigo-600 hover:text-indigo-800 border px-3 py-1 rounded">Parent Login</a>
            <a href="../admin/index.html" class="inline-block text-gray-600 hover:text-gray-800 text-sm">Admin
                Access</a>
        </div>
    </div>

    <div id="debug-info"
        class="fixed bottom-0 left-0 bg-black text-white p-4 text-xs font-mono hidden w-full opacity-90 z-50"></div>

    <script type="module">
        import { supabase } from '../assets/js/supabase-client.js';

        function log(msg) {
            console.log(msg);
            const d = document.getElementById('debug-info');
            d.innerHTML += `<div>${msg}</div>`;
        }

        async function init() {
            try {
                // 1. Get Student ID
                const urlParams = new URLSearchParams(window.location.search);
                const studentId = urlParams.get('id');

                if (!studentId) {
                    showError('No Student ID provided in URL');
                    return;
                }

                log(`Checking ID: ${studentId}`);

                // 2. Resolve User
                let currentUser = null;
                let isAdmin = false;

                // Check LocalStorage
                const localSession = localStorage.getItem('school_user_custom');
                if (localSession) {
                    try {
                        const s = JSON.parse(localSession);
                        if (s && s.user) {
                            currentUser = s.user;
                            currentUser.isCustom = true;
                            log(`Local User Found: ${currentUser.phone}`);
                        }
                    } catch (e) { log('Session corrupted'); }
                }

                // Check Supabase (Admin overrides)
                // Only check if we suspect admin or no local user
                const { data: { user: sbUser } } = await supabase.auth.getUser();
                if (sbUser) {
                    const { data: profile } = await supabase.from('profiles').select('role').eq('id', sbUser.id).single();
                    if (profile && profile.role === 'admin') {
                        currentUser = sbUser;
                        isAdmin = true;
                        log('Admin Logged In');
                    }
                }

                if (!currentUser) {
                    log('No user. Redirecting...');
                    // Redirect Logic
                    const returnUrl = encodeURIComponent(window.location.href);
                    window.location.replace(`../parent/login.html?redirect=${returnUrl}`);
                    return;
                }

                // 3. Fetch Data
                const { data: student, error } = await supabase
                    .from('students')
                    .select('*, parent_requests(id, full_name, phone_number)')
                    .eq('id', studentId)
                    .single();

                if (error || !student) {
                    showError('Student not found in database.');
                    log(error ? error.message : 'NULL Data');
                    return;
                }

                log(`Student Parent ID: ${student.parent_id}`);
                log(`Current User ID: ${currentUser.id}`);

                // 4. Verify Access
                let isAllowed = false;
                if (isAdmin) isAllowed = true;
                else if (currentUser.isCustom && student.parent_id === currentUser.id) isAllowed = true;

                if (!isAllowed) {
                    showError('Access Denied: ID Mismatch');
                    // Show debug automatically on error
                    document.getElementById('debug-info').classList.remove('hidden');
                    log(` EXPECTED: ${student.parent_id}`);
                    log(` ACTUAL:   ${currentUser.id}`);
                    return;
                }

                // 5. Success - Fetch Details
                // Fetch Teacher & Performance
                const { data: teacher } = await supabase.from('teachers').select('*').eq('grade', student.grade).single();
                const { data: perf } = await supabase.from('performance').select('*').eq('student_id', studentId).order('created_at', { ascending: false });

                render(student, teacher, perf);

            } catch (err) {
                console.error(err);
                showError('System Error: ' + err.message);
            }
        }

        function render(student, teacher, performance) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('card-container').classList.remove('hidden');

            document.getElementById('stu-name').textContent = student.full_name;
            document.getElementById('stu-grade').textContent = student.grade;
            if (student.photo_url) document.getElementById('stu-photo').src = student.photo_url;

            document.getElementById('parent-name').textContent = student.parent_requests?.full_name || 'N/A';
            document.getElementById('parent-contact').textContent = student.parent_requests?.phone_number || 'N/A';

            if (teacher) {
                document.getElementById('teacher-info').innerHTML = `
                   <div class="flex items-center bg-indigo-50 p-3 rounded-lg mt-4 border border-indigo-100">
                        <img src="${teacher.photo_url || 'https://placehold.co/100'}" class="w-12 h-12 rounded-full object-cover mr-3">
                        <div><p class="text-xs text-indigo-500 font-bold">Class Teacher</p><p class="font-semibold text-sm">${teacher.name}</p></div>
                   </div>`;
            }

            if (performance && performance.length > 0) {
                const latest = performance[0];
                document.getElementById('perf-container').innerHTML = `
                   <div class="mt-6 pt-6 border-t border-gray-100">
                        <p class="text-xs text-gray-400 uppercase tracking-wide mb-3">Performance (${latest.term})</p>
                        <div class="grid grid-cols-2 gap-2">
                             ${performance.slice(0, 4).map(p => `<div class="bg-gray-50 p-2 rounded text-center"><p class="text-xs text-gray-500">${p.subject}</p><p class="font-bold">${p.score}</p></div>`).join('')}
                        </div>
                   </div>`;
            }
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            const errDiv = document.getElementById('error-msg');
            errDiv.classList.remove('hidden');
            errDiv.querySelector('h2').textContent = msg; // Show specific reason logic
        }

        init();
    </script>
</body>

</html>